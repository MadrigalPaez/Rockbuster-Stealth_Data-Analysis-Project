-- Average amount paid by the Top 5 customers, from the Top cities from the Top 10 countries:

WITH total_spent AS ( SELECT
customer.customer_id,
SUM(payment.amount) AS total_spent FROM customer
INNER JOIN payment
ON customer.customer_id = payment.customer_id INNER JOIN address
ON customer.address_id = address.address_id INNER JOIN city
ON address.city_id = city.city_id INNER JOIN country
ON city.country_id = country.country_id WHERE city.city IN
('Aurora', 'Atlixco', 'Xintai', 'Adoni', 'Dhule (Dhulia)',
'Kurashiki', 'Pingxiang', 'Sivas', 'Celaya', 'So Leopoldo') AND country.country IN
('India', 'China', 'United States', 'Japan', 'Mexico',
'Brazil', 'Russian Federation', 'Philippines', 'Turkey', 'Indonesia') GROUP BY customer.customer_id
ORDER BY total_spent DESC
LIMIT 5)
SELECT
AVG(total_spent) AS avg_spent_top5customers
FROM total_spent
